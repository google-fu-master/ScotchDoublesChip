// Prisma Schema for Scotch Doubles Chip Tournament System
// Focused on pool hall tournament management

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core models for tournament management
model Player {
  id        String   @id @default(cuid())
  email     String   @unique
  firstName String
  lastName  String
  phone     String?
  
  // Birthday chip tracking (month/day only, no year)
  birthdayMonth     Int? // 1-12
  birthdayDay       Int? // 1-31
  lastBirthdayChip  DateTime? // When they last received a birthday chip
  
  // Player preferences and settings
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  tournamentProfiles PlayerProfile[]
  directorRoles     TournamentDirector[]
  payoutSplits      PayoutSplit[]
  sidePotEntries    SidePotEntry[]

  @@map("players")
}

// Venue management for pool halls
model Venue {
  id          String   @id @default(cuid())
  name        String
  address     String?
  phone       String?
  email       String?
  
  // Table management
  totalTables Int
  settings    Json? // Operating hours, rules, etc.
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  tournaments Tournament[]
  tables      Table[]

  @@map("venues")
}

model Table {
  id        String @id @default(cuid())
  venueId   String
  number    String // Table identifier (1, 2, "Bar Table", etc.)
  isActive  Boolean @default(true)
  
  // Table status
  status    TableStatus @default(AVAILABLE)
  settings  Json? // Table-specific settings
  lastAssignedAt DateTime?
  currentWinningTeamId String?
  closedBy String?
  closedAt DateTime?
  
  // Relationships
  venue     Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)
  games     Game[]
  assignedTeams Team[]
  teamAssignments TeamAssignment[]

  @@unique([venueId, number])
  @@map("tables")
}

enum TableStatus {
  AVAILABLE
  IN_USE
  OUT_OF_ORDER
  RESERVED
}

// Tournament management with proper roles
model Tournament {
  id          String          @id @default(cuid())
  name        String
  description String?
  venueId     String
  
  // Tournament configuration
  tournamentType TournamentType  @default(CHIP)
  format         TournamentFormat @default(SCOTCH_DOUBLES)
  playerType     PlayerType @default(SCOTCH_DOUBLES)
  gameType       GameType @default(NINE_BALL)
  status         TournamentStatus @default(SETUP)
  
  // Chip tournament settings
  settings       Json            // Tournament-specific configuration
  rules          Json?           // Tournament rules
  defaultChipsPerPlayer Int @default(3)
  chipRanges     Json?           // FARGO-based chip distribution ranges
  
  // Tournament flow
  bracketOrdering BracketOrdering @default(RANDOM)
  autopilotMode   Boolean @default(false)
  autoAcceptScores Boolean @default(true)
  randomOrderingEachRound Boolean @default(false)
  raceToWins     Int @default(1)
  playersPerTable Int @default(4)
  currentRound   Int @default(1)
  maxRounds      Int?
  
  // Financial settings
  adminFee       Decimal @default(0)
  addedMoney     Decimal @default(0)
  payoutType     PayoutType @default(PERCENTAGE)
  payoutPlacesSetting PayoutPlacesSetting @default(TOP_3)
  payoutPercentage Float @default(25.0)
  customPayoutStructure Json?
  
  // Tournament state
  isCompleted    Boolean @default(false)
  isStarted      Boolean @default(false)
  
  // Scheduling
  startDate      DateTime?
  endDate        DateTime?
  registrationOpenDate  DateTime?
  registrationCloseDate DateTime?
  
  // Registration limits
  maxTeams       Int?
  minTeams       Int?
  estimatedEntrants Int?
  entryFee       Decimal?
  
  // Chip configuration
  startingChips  Int @default(3) // Chips per team at registration
  
  // Metadata
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relationships
  venue          Venue @relation(fields: [venueId], references: [id])
  directors      TournamentDirector[]
  playerProfiles PlayerProfile[]
  teams          Team[]
  games          Game[]
  chipTransactions ChipTransaction[]
  payouts        Payout[]
  sidePots       SidePot[]
  queue          TournamentQueue?
  teamPairings   TeamPairing[]
  teamAssignments TeamAssignment[]

  @@map("tournaments")
}

model TournamentDirector {
  id           String @id @default(cuid())
  tournamentId String
  playerId     String
  role         DirectorRole
  createdAt    DateTime @default(now())

  // Relationships
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  player       Player @relation(fields: [playerId], references: [id], onDelete: Cascade)

  @@unique([tournamentId, playerId])
  @@map("tournament_directors")
}

model PlayerProfile {
  id           String @id @default(cuid())
  tournamentId String
  playerId     String
  
  // Tournament-specific player data
  displayName  String
  skillLevel   String?
  handicap     Int? // For future use
  
  // Registration status
  registrationStatus PlayerRegistrationStatus @default(PENDING)
  registeredAt       DateTime @default(now())
  checkedInAt        DateTime?
  
  // Birthday chip tracking
  receivedBirthdayChip Boolean @default(false)
  birthdayChipDate     DateTime?
  
  // Settings for this tournament
  settings     Json?
  
  // Relationships
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  player       Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  teamMemberships TeamMember[]
  gameResults  GameResult[]
  chipTransactions ChipTransaction[]

  @@unique([tournamentId, playerId])
  @@map("player_profiles")
}

model Team {
  id           String @id @default(cuid())
  tournamentId String
  name         String
  
  // Team status and chip tracking
  status       TeamStatus @default(ACTIVE)
  currentChips Int @default(0) // Current chip count
  totalChipsWon Int @default(0) // Total chips won throughout tournament
  totalChipsLost Int @default(0) // Total chips lost
  manualChipOverride Boolean @default(false) // Tracks manual chip adjustments
  initialChips Int @default(0) // Initial chip allocation
  
  // Queue and table assignment
  isQueued      Boolean @default(false)
  queuePosition Int?
  currentTableId String?
  assignedAt    DateTime?
  
  // Performance tracking
  gamesPlayed      Int @default(0)
  gamesWon         Int @default(0)
  currentWinStreak Int @default(0)
  longestWinStreak Int @default(0)
  
  // FARGO and seeding
  combinedFargo    Int?
  
  // Team metadata
  seed         Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  currentTable Table? @relation(fields: [currentTableId], references: [id])
  members      TeamMember[]
  gamesAsWinner Game[] @relation("WinningTeam")
  gamesAsLoser  Game[] @relation("LosingTeam")
  payouts      Payout[]
  payoutSplits PayoutSplit[]
  sidePotEntries SidePotEntry[]
  team1Pairings TeamPairing[] @relation("Team1Pairings")
  team2Pairings TeamPairing[] @relation("Team2Pairings")
  assignments   TeamAssignment[]

  @@map("teams")
}

model TeamMember {
  id              String @id @default(cuid())
  teamId          String
  playerProfileId String
  position        String? // "Player 1", "Player 2" for Scotch Doubles
  isActive        Boolean @default(true)
  joinedAt        DateTime @default(now())

  // Relationships
  team          Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  playerProfile PlayerProfile @relation(fields: [playerProfileId], references: [id], onDelete: Cascade)

  @@unique([teamId, playerProfileId])
  @@map("team_members")
}

// Games - winners stay, losers move to open tables
model Game {
  id           String @id @default(cuid())
  tournamentId String
  tableId      String?
  
  // Game identification
  gameNumber   Int
  round        Int?
  gameType     String @default("pool") // Pool, darts, etc.
  
  // Teams involved (no home/away concept)
  winningTeamId String?
  losingTeamId  String?
  
  // Game status and timing
  status       GameStatus @default(NOT_STARTED)
  raceToWins   Int @default(1)
  winningTeamScore Int?
  losingTeamScore Int?
  scoresSubmitted Boolean @default(false)
  scoresApproved Boolean @default(false)
  approvedBy String?
  submittedBy String?
  startedAt    DateTime?
  completedAt  DateTime?
  
  // Game results
  winnerStays  Boolean @default(true) // Winner stays at table
  chipsAwarded Int @default(1) // Chips awarded to winner
  
  // Game-specific data
  gameData     Json? // Rack info, break player, etc.
  notes        String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  table        Table? @relation(fields: [tableId], references: [id])
  winningTeam  Team? @relation("WinningTeam", fields: [winningTeamId], references: [id])
  losingTeam   Team? @relation("LosingTeam", fields: [losingTeamId], references: [id])
  results      GameResult[]
  chipTransactions ChipTransaction[]

  @@map("games")
}

model GameResult {
  id              String @id @default(cuid())
  gameId          String
  playerProfileId String
  
  // Individual player performance in the game
  score           Int? // Individual score if applicable
  performance     Json? // Detailed performance metrics
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  game            Game @relation(fields: [gameId], references: [id], onDelete: Cascade)
  playerProfile   PlayerProfile @relation(fields: [playerProfileId], references: [id], onDelete: Cascade)

  @@unique([gameId, playerProfileId])
  @@map("game_results")
}

// Chip transactions for team chip tracking
model ChipTransaction {
  id              String @id @default(cuid())
  tournamentId    String
  playerProfileId String?
  teamId          String? // Added team relationship
  gameId          String?
  
  // Transaction details
  type            ChipTransactionType
  amount          Int // Positive for awards, negative for losses
  reason          String?
  description     String?
  
  // Context
  createdAt       DateTime @default(now())
  createdBy       String? // Player/director who created

  // Relationships
  tournament      Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  playerProfile   PlayerProfile? @relation(fields: [playerProfileId], references: [id])
  game            Game? @relation(fields: [gameId], references: [id])

  @@map("chip_transactions")
}

// Payout structure for tournaments
model Payout {
  id           String @id @default(cuid())
  tournamentId String
  teamId       String? // Team that received this payout
  
  // Payout details
  position     Int // 1st, 2nd, 3rd, etc.
  amount       Decimal
  originalAmount Decimal?
  percentage   Decimal? // Percentage of total pot
  description  String? // "1st Place", "Runner-up", etc.
  
  // Payout status
  isPaid       Boolean @default(false)
  isSplit      Boolean @default(false)
  paidAt       DateTime?
  paidTo       String? // Team or player ID
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  team         Team? @relation(fields: [teamId], references: [id], onDelete: SetNull)
  splits       PayoutSplit[]

  @@map("payouts")
}

// Side pots for additional betting/prizes
model SidePot {
  id           String @id @default(cuid())
  tournamentId String
  
  // Side pot details
  name         String // "Break and Run", "High Run", etc.
  description  String?
  amount       Decimal
  entryFee     Decimal?
  entryType    SidePotEntryType @default(MANUAL)
  totalPot     Decimal @default(0)
  
  // Qualification criteria
  criteria     Json // Flexible criteria definition
  
  // Status
  isActive     Boolean @default(true)
  isComplete   Boolean @default(false)
  paidOut      Boolean @default(false)
  winnerId     String? // Winner team or player ID
  winnerType   String? // Type of winner (TEAM, PLAYER, etc.)
  paidAt       DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  entries      SidePotEntry[]

  @@map("side_pots")
}

model SidePotEntry {
  id         String @id @default(cuid())
  sidePotId  String
  teamId     String?
  playerId   String?
  
  // Entry details
  entrantType SidePotEntryType
  entryFee    Decimal
  enteredAt   DateTime @default(now())
  
  // Relationships
  sidePot     SidePot @relation(fields: [sidePotId], references: [id], onDelete: Cascade)
  team        Team? @relation(fields: [teamId], references: [id], onDelete: SetNull)
  player      Player? @relation(fields: [playerId], references: [id], onDelete: SetNull)
  
  @@unique([sidePotId, teamId])
  @@unique([sidePotId, playerId])
  @@map("side_pot_entries")
}

model PayoutSplit {
  id          String @id @default(cuid())
  payoutId    String
  teamId      String
  tournamentId String
  playerId    String?
  
  // Split details
  splitName   String?
  splitData   Json?
  amount      Decimal
  totalAmount Decimal?
  percentage  Decimal?
  description String?
  createdBy   String?
  
  createdAt   DateTime @default(now())
  
  // Relationships
  payout      Payout @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  team        Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player      Player? @relation(fields: [playerId], references: [id], onDelete: SetNull)
  
  @@map("payout_splits")
}

// System models for audit, notifications, and administration
model AuditLog {
  id           String @id @default(cuid())
  
  // Event identification
  entityType   String   // Table/model name
  entityId     String   // Record ID
  action       AuditAction
  
  // Change tracking
  oldValues    Json?
  newValues    Json?
  
  // Context
  userId       String?
  sessionId    String?
  ipAddress    String?
  userAgent    String?
  
  // Metadata
  timestamp    DateTime @default(now())
  
  @@map("audit_logs")
}

model ErrorLog {
  id           String @id @default(cuid())
  
  // Error details
  errorType    String
  errorMessage String
  message      String?
  errorStack   String?
  stack        String?
  code         String?
  context      Json?
  
  // Error categorization
  severity     String // ERROR, WARNING, INFO
  category     String // SERVICE_ERROR, VALIDATION_ERROR, SYSTEM_ERROR
  
  // Request context
  userId       String?
  tournamentId String?
  sessionId    String?
  requestId    String?
  correlationId String?
  
  // System context  
  service      String?
  method       String?
  endpoint     String?
  
  // Metadata
  timestamp    DateTime @default(now())
  resolved     Boolean @default(false)
  resolvedAt   DateTime?
  resolvedBy   String?
  
  @@map("error_logs")
  @@index([errorType])
  @@index([category])
  @@index([severity])
  @@index([timestamp])
}

model Notification {
  id           String @id @default(cuid())
  
  // Recipient
  userId       String?
  email        String?
  
  // Content
  type         NotificationType
  title        String
  message      String
  data         Json?    // Additional notification data
  
  // Delivery
  channel      NotificationChannel
  status       NotificationStatus @default(PENDING)
  sentAt       DateTime?
  readAt       DateTime?
  
  // Metadata
  createdAt    DateTime @default(now())
  
  @@map("notifications")
}

model SystemConfig {
  id          String @id @default(cuid())
  key         String @unique
  value       String
  type        ConfigType
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@map("system_config")
}

// Updated enum definitions for pool hall tournaments
enum DirectorRole {
  TOURNAMENT_DIRECTOR
  TOURNAMENT_MANAGER
  ADMIN
  VIEWER
}

enum TournamentType {
  CHIP        // Chip accumulation tournament
  ELIMINATION // Single/Double elimination  
  ROUND_ROBIN // Round robin format
  SWISS       // Swiss system
  CUSTOM      // Custom format
}

enum TournamentFormat {
  SINGLES
  DOUBLES
  SCOTCH_DOUBLES
  TEAMS
}

enum PlayerType {
  SINGLES
  DOUBLES
  SCOTCH_DOUBLES
  TEAMS
}

enum GameType {
  EIGHT_BALL
  NINE_BALL
  TEN_BALL
  STRAIGHT_POOL
  ONE_POCKET
  BANK_POOL
  SNOOKER
}

enum AssignmentType {
  AUTO
  MANUAL  
  PRIORITY
  INITIAL
  FROM_QUEUE
  WINNER_STAYS
}

enum BracketOrdering {
  RANDOM
  RANDOM_DRAW  // Alias for RANDOM
  FARGO_HIGH_TO_LOW
  FARGO_LOW_TO_HIGH
  SEEDED_DRAW  // Ordered by seed/skill
  REGISTRATION_ORDER
  SET_ORDER   // Manually set order
}

enum Rules {
  BCA
  APA
  TAP
  VNEA
  CUSTOM
}

enum RatingSystem {
  FARGO
  APA
  TAP
  VNEA
  ELO
  CUSTOM
}

enum PayoutType {
  PERCENTAGE
  FIXED_AMOUNT
  WINNER_TAKE_ALL
  CUSTOM
  PLACES
}

enum PayoutPlacesSetting {
  TOP_2
  TOP_3
  TOP_4  
  TOP_5
  TOP_6
  TOP_8
  PERCENTAGE_BASED
  WINNER_TAKE_ALL
  CUSTOM
}

enum AccessType {
  PUBLIC
  PRIVATE
  INVITE_ONLY
  MEMBERS_ONLY
}

enum SidePotEntryType {
  AUTOMATIC
  MANUAL  
  OPT_IN
  TEAM
  INDIVIDUAL
}

enum SidePotWinnerType {
  HIGH_RUN
  BREAKS
  SAFETIES
  CUSTOM
}

enum TournamentStatus {
  SETUP
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  IN_PROGRESS
  PAUSED
  COMPLETED
  CANCELLED
}

enum PlayerRegistrationStatus {
  PENDING
  CONFIRMED
  WAITLISTED
  DECLINED
  CANCELLED
}

enum TeamStatus {
  ACTIVE
  ELIMINATED
  WITHDRAWN
}

enum GameStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ChipTransactionType {
  INITIAL_CHIPS    // Chips given at team registration
  GAME_WIN        // Chips won from game victory
  GAME_LOSS       // Chips lost from game defeat  
  BIRTHDAY_CHIP   // Special birthday chip award
  ADJUSTMENT      // Manual adjustment
  MANUAL_ADJUSTMENT // Manual chip adjustment (alias for ADJUSTMENT)
  PRIZE          // Prize distribution
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

enum NotificationType {
  TOURNAMENT_REMINDER
  MATCH_STARTING
  RESULT_UPDATE
  REGISTRATION_CONFIRMATION
  SYSTEM_ALERT
  ERROR_ALERT
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum ConfigType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// Tournament Queue Management
model TournamentQueue {
  id           String @id @default(cuid())
  tournamentId String @unique
  
  // Queue configuration
  isActive     Boolean @default(true)
  currentRound Int @default(1)
  queueOrder   Json    // Serialized array of team IDs in queue order
  lastShuffled DateTime?
  shuffledBy   String?
  
  // Metadata
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relationships
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  
  @@map("tournament_queues")
}

// Team Pairing History
model TeamPairing {
  id           String @id @default(cuid())
  tournamentId String
  team1Id      String
  team2Id      String
  
  // Pairing details
  round        Int
  gamesPlayed  Int @default(0)
  lastPlayedAt DateTime?
  
  // Win tracking
  team1Wins    Int @default(0)
  team2Wins    Int @default(0)
  
  // Metadata
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relationships
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  team1        Team @relation("Team1Pairings", fields: [team1Id], references: [id], onDelete: Cascade)
  team2        Team @relation("Team2Pairings", fields: [team2Id], references: [id], onDelete: Cascade)
  
  @@unique([tournamentId, team1Id, team2Id])
  @@map("team_pairings")
}

// Team Assignment Tracking
model TeamAssignment {
  id             String @id @default(cuid())
  teamId         String
  tableId        String?
  tournamentId   String
  assignmentType AssignmentType
  assignedAt     DateTime @default(now())
  assignedBy     String?
  
  // Relationships
  team           Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  table          Table? @relation(fields: [tableId], references: [id])
  tournament     Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  
  @@map("team_assignments")
}