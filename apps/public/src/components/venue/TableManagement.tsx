'use client';\n\nimport { useState, useEffect } from 'react';\nimport { Hash, Plus, Edit3, Trash2, Save, X, AlertTriangle, Building, Users, Clock } from 'lucide-react';\nimport {\n  TableAgeRestriction,\n  TableAgeRestrictionLabels,\n  VenueAgeRestriction,\n  VenueAgeRestrictionLabels,\n  AgeRestrictionUtils\n} from '../../../shared/types/age-restriction.types';\n\ninterface Table {\n  id: string;\n  number: string;\n  venueId: string;\n  isActive: boolean;\n  ageRestriction?: TableAgeRestriction;\n  // Additional table properties\n  manufacturer?: string;\n  size?: string;\n  status?: 'OPEN' | 'IN_USE' | 'CLOSED';\n}\n\ninterface Venue {\n  id: string;\n  name: string;\n  ageRestriction: VenueAgeRestriction;\n  useVenueAgeForAllTables: boolean;\n  totalTables: number;\n}\n\ninterface TableManagementProps {\n  venue: Venue;\n  tables: Table[];\n  onUpdateVenue: (venueId: string, updates: Partial<Venue>) => Promise<void>;\n  onUpdateTable: (tableId: string, updates: Partial<Table>) => Promise<void>;\n  onCreateTable: (tableData: Omit<Table, 'id'>) => Promise<void>;\n  onDeleteTable: (tableId: string) => Promise<void>;\n  canEdit?: boolean;\n}\n\nexport function TableManagement({ \n  venue, \n  tables, \n  onUpdateVenue, \n  onUpdateTable, \n  onCreateTable, \n  onDeleteTable,\n  canEdit = false \n}: TableManagementProps) {\n  const [isEditing, setIsEditing] = useState(false);\n  const [editingTable, setEditingTable] = useState<string | null>(null);\n  const [showAddTable, setShowAddTable] = useState(false);\n  const [loading, setLoading] = useState(false);\n  \n  const [venueAgeMode, setVenueAgeMode] = useState(venue.useVenueAgeForAllTables);\n  const [newTable, setNewTable] = useState({\n    number: '',\n    manufacturer: '',\n    size: '9 Foot',\n    ageRestriction: TableAgeRestriction.UNDER_18 as TableAgeRestriction | undefined,\n    isActive: true\n  });\n\n  const effectiveTableRestriction = (table: Table): TableAgeRestriction => {\n    if (venue.useVenueAgeForAllTables) {\n      return AgeRestrictionUtils.getEffectiveTableAgeRestriction(\n        venue.ageRestriction,\n        true\n      );\n    }\n    return table.ageRestriction || TableAgeRestriction.UNDER_18;\n  };\n\n  const handleVenueAgeModeChange = async (useVenueAge: boolean) => {\n    if (!canEdit) return;\n    \n    setLoading(true);\n    try {\n      await onUpdateVenue(venue.id, { useVenueAgeForAllTables: useVenueAge });\n      setVenueAgeMode(useVenueAge);\n      \n      // If switching to venue mode, update all tables to undefined (they'll inherit)\n      if (useVenueAge) {\n        for (const table of tables) {\n          await onUpdateTable(table.id, { ageRestriction: undefined });\n        }\n      }\n    } catch (error) {\n      console.error('Failed to update venue age mode:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleTableAgeChange = async (tableId: string, ageRestriction: TableAgeRestriction) => {\n    if (!canEdit || venue.useVenueAgeForAllTables) return;\n    \n    setLoading(true);\n    try {\n      await onUpdateTable(tableId, { ageRestriction });\n    } catch (error) {\n      console.error('Failed to update table age restriction:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleCreateTable = async () => {\n    if (!newTable.number.trim()) {\n      alert('Table number is required');\n      return;\n    }\n\n    // Check for duplicate table numbers\n    if (tables.some(t => t.number === newTable.number.trim())) {\n      alert('A table with this number already exists');\n      return;\n    }\n\n    setLoading(true);\n    try {\n      await onCreateTable({\n        number: newTable.number.trim(),\n        venueId: venue.id,\n        isActive: newTable.isActive,\n        ageRestriction: venue.useVenueAgeForAllTables ? undefined : newTable.ageRestriction\n      });\n      \n      setNewTable({\n        number: '',\n        manufacturer: '',\n        size: '9 Foot',\n        ageRestriction: TableAgeRestriction.UNDER_18,\n        isActive: true\n      });\n      setShowAddTable(false);\n    } catch (error) {\n      console.error('Failed to create table:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2\">\n            <Building className=\"h-6 w-6\" />\n            {venue.name} - Table Management\n          </h2>\n          <p className=\"text-gray-600 dark:text-gray-400 mt-1\">\n            Manage tables and their age restrictions for this venue\n          </p>\n        </div>\n        \n        {canEdit && (\n          <button\n            onClick={() => setShowAddTable(true)}\n            className=\"bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2\"\n          >\n            <Plus className=\"h-4 w-4\" />\n            Add Table\n          </button>\n        )}\n      </div>\n\n      {/* Venue Age Restriction Info */}\n      <div className=\"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4\">\n        <h3 className=\"font-semibold text-blue-900 dark:text-blue-100 mb-2 flex items-center gap-2\">\n          <AlertTriangle className=\"h-5 w-5\" />\n          Venue Age Restriction Policy\n        </h3>\n        <div className=\"text-blue-800 dark:text-blue-200\">\n          <span className=\"font-medium\">Current Policy:</span> {VenueAgeRestrictionLabels[venue.ageRestriction]}\n        </div>\n      </div>\n\n      {/* Table Age Restriction Mode */}\n      <div className=\"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6\">\n        <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">Table Age Restriction Management</h3>\n        \n        <div className=\"space-y-3\">\n          <label className=\"flex items-start gap-3\">\n            <input\n              type=\"radio\"\n              checked={venueAgeMode}\n              onChange={() => handleVenueAgeModeChange(true)}\n              disabled={!canEdit || loading}\n              className=\"mt-1 text-purple-600 focus:ring-purple-500\"\n            />\n            <div className=\"flex-1\">\n              <div className=\"font-medium text-gray-900 dark:text-white\">\n                Apply Venue Age Restriction to All Tables\n              </div>\n              <div className=\"text-sm text-gray-600 dark:text-gray-400\">\n                All tables will automatically inherit the venue's age restriction policy. \n                Table-specific restrictions will be disabled.\n              </div>\n            </div>\n          </label>\n          \n          <label className=\"flex items-start gap-3\">\n            <input\n              type=\"radio\"\n              checked={!venueAgeMode}\n              onChange={() => handleVenueAgeModeChange(false)}\n              disabled={!canEdit || loading}\n              className=\"mt-1 text-purple-600 focus:ring-purple-500\"\n            />\n            <div className=\"flex-1\">\n              <div className=\"font-medium text-gray-900 dark:text-white\">\n                Set Table Age Restrictions Manually\n              </div>\n              <div className=\"text-sm text-gray-600 dark:text-gray-400\">\n                Each table can have its own age restriction setting, allowing for mixed-age sections within the venue.\n              </div>\n            </div>\n          </label>\n        </div>\n      </div>\n\n      {/* Tables List */}\n      <div className=\"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden\">\n        <div className=\"px-6 py-4 border-b border-gray-200 dark:border-gray-700\">\n          <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2\">\n            <Hash className=\"h-5 w-5\" />\n            Tables ({tables.length})\n          </h3>\n        </div>\n        \n        {tables.length === 0 ? (\n          <div className=\"p-6 text-center text-gray-500 dark:text-gray-400\">\n            No tables configured for this venue yet.\n            {canEdit && (\n              <>\n                <br />\n                <button\n                  onClick={() => setShowAddTable(true)}\n                  className=\"mt-2 text-purple-600 hover:text-purple-700\"\n                >\n                  Add the first table\n                </button>\n              </>\n            )}\n          </div>\n        ) : (\n          <div className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n            {tables.map((table) => {\n              const effective = effectiveTableRestriction(table);\n              \n              return (\n                <div key={table.id} className=\"p-6\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n                          Table {table.number}\n                        </div>\n                        <div className={`px-2 py-1 rounded-full text-xs font-medium ${\n                          table.isActive \n                            ? 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400'\n                            : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400'\n                        }`}>\n                          {table.isActive ? 'Active' : 'Inactive'}\n                        </div>\n                      </div>\n                      \n                      <div className=\"mt-2 flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400\">\n                        <div className=\"flex items-center gap-1\">\n                          <Users className=\"h-4 w-4\" />\n                          <span>Age Restriction: <span className=\"font-medium\">{TableAgeRestrictionLabels[effective]}</span></span>\n                          {venue.useVenueAgeForAllTables && (\n                            <span className=\"text-xs text-blue-600 dark:text-blue-400\">(inherited from venue)</span>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                    \n                    {canEdit && !venue.useVenueAgeForAllTables && (\n                      <div className=\"flex items-center gap-3\">\n                        <select\n                          value={table.ageRestriction || TableAgeRestriction.UNDER_18}\n                          onChange={(e) => handleTableAgeChange(table.id, e.target.value as TableAgeRestriction)}\n                          disabled={loading}\n                          className=\"px-3 py-1 border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm\"\n                        >\n                          {Object.entries(TableAgeRestrictionLabels).map(([value, label]) => (\n                            <option key={value} value={value}>\n                              {label}\n                            </option>\n                          ))}\n                        </select>\n                      </div>\n                    )}\n                    \n                    {canEdit && (\n                      <div className=\"ml-3\">\n                        <button\n                          onClick={() => onDeleteTable(table.id)}\n                          className=\"p-2 text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20 rounded\"\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </button>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        )}\n      </div>\n\n      {/* Add Table Modal */}\n      {showAddTable && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\">\n          <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full\">\n            <div className=\"p-6\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">Add New Table</h3>\n                <button\n                  onClick={() => setShowAddTable(false)}\n                  className=\"text-gray-400 hover:text-gray-600\"\n                >\n                  <X className=\"h-6 w-6\" />\n                </button>\n              </div>\n              \n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                    Table Number/Name *\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={newTable.number}\n                    onChange={(e) => setNewTable({...newTable, number: e.target.value})}\n                    className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\n                    placeholder=\"e.g., 1, 2, Bar Table, etc.\"\n                    required\n                  />\n                </div>\n                \n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                    Size\n                  </label>\n                  <select\n                    value={newTable.size}\n                    onChange={(e) => setNewTable({...newTable, size: e.target.value})}\n                    className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\n                  >\n                    <option value=\"6.5 Foot\">6.5 Foot</option>\n                    <option value=\"7 Foot\">7 Foot</option>\n                    <option value=\"8 Foot\">8 Foot</option>\n                    <option value=\"9 Foot\">9 Foot</option>\n                    <option value=\"10 Foot\">10 Foot</option>\n                    <option value=\"12 Foot\">12 Foot</option>\n                  </select>\n                </div>\n                \n                {!venue.useVenueAgeForAllTables && (\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                      Age Restriction\n                    </label>\n                    <select\n                      value={newTable.ageRestriction}\n                      onChange={(e) => setNewTable({...newTable, ageRestriction: e.target.value as TableAgeRestriction})}\n                      className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\n                    >\n                      {Object.entries(TableAgeRestrictionLabels).map(([value, label]) => (\n                        <option key={value} value={value}>\n                          {label}\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                )}\n                \n                <div className=\"flex items-center\">\n                  <input\n                    type=\"checkbox\"\n                    checked={newTable.isActive}\n                    onChange={(e) => setNewTable({...newTable, isActive: e.target.checked})}\n                    className=\"rounded border-gray-300 text-purple-600 focus:ring-purple-500\"\n                  />\n                  <label className=\"ml-2 text-sm text-gray-700 dark:text-gray-300\">\n                    Table is active\n                  </label>\n                </div>\n              </div>\n              \n              <div className=\"flex gap-3 mt-6\">\n                <button\n                  onClick={() => setShowAddTable(false)}\n                  disabled={loading}\n                  className=\"flex-1 px-4 py-2 border border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-50 disabled:opacity-50\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={handleCreateTable}\n                  disabled={loading}\n                  className=\"flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-purple-400 flex items-center justify-center gap-2\"\n                >\n                  {loading ? (\n                    <>\n                      <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white\"></div>\n                      Creating...\n                    </>\n                  ) : (\n                    <>\n                      <Save className=\"h-4 w-4\" />\n                      Create Table\n                    </>\n                  )}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n      \n      {/* Age Restriction Info */}\n      <div className=\"bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 rounded-lg p-4\">\n        <h4 className=\"font-semibold text-gray-900 dark:text-white mb-2\">Age Restriction Access Rules</h4>\n        <div className=\"text-sm text-gray-600 dark:text-gray-400 space-y-1\">\n          <div><span className=\"font-medium\">&lt;18 tables:</span> Players of all ages can be assigned</div>\n          <div><span className=\"font-medium\">18-20 tables:</span> Only 18-20 and 21+ players can be assigned</div>\n          <div><span className=\"font-medium\">21+ tables:</span> Only 21+ players can be assigned</div>\n          <div className=\"mt-2 text-xs text-gray-500\">\n            Tournament directors can override player age settings temporarily for specific tournaments if needed.\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}"