'use client';\n\nimport { useState, useEffect } from 'react';\nimport { Building, User, Clock, Check, X, AlertCircle, Edit3, UserCheck } from 'lucide-react';\nimport { VenueEditRequestStatus } from '../../../shared/types/age-restriction.types';\n\ninterface VenueEditRequest {\n  id: string;\n  venueId: string;\n  requesterId: string;\n  requester: {\n    firstName: string;\n    lastName: string;\n    email: string;\n  };\n  proposedChanges: Record<string, any>;\n  status: VenueEditRequestStatus;\n  reviewedById?: string;\n  rejectionReason?: string;\n  createdAt: Date;\n  reviewedAt?: Date;\n  expiresAt: Date;\n}\n\ninterface Venue {\n  id: string;\n  name: string;\n  ownerId?: string;\n  owner?: {\n    firstName: string;\n    lastName: string;\n    email: string;\n  };\n}\n\ninterface VenueEditApprovalProps {\n  venue: Venue;\n  editRequests: VenueEditRequest[];\n  onApprove: (requestId: string, changes?: Partial<any>) => Promise<void>;\n  onReject: (requestId: string, reason: string) => Promise<void>;\n  onTransferOwnership: (venueId: string, newOwnerId: string) => Promise<void>;\n  currentUserId: string;\n  canManage?: boolean;\n}\n\nexport function VenueEditApproval({\n  venue,\n  editRequests,\n  onApprove,\n  onReject,\n  onTransferOwnership,\n  currentUserId,\n  canManage = false\n}: VenueEditApprovalProps) {\n  const [selectedRequest, setSelectedRequest] = useState<VenueEditRequest | null>(null);\n  const [rejectionReason, setRejectionReason] = useState('');\n  const [showTransferDialog, setShowTransferDialog] = useState(false);\n  const [transferToUserId, setTransferToUserId] = useState('');\n  const [loading, setLoading] = useState(false);\n\n  const isOwner = venue.ownerId === currentUserId;\n  const pendingRequests = editRequests.filter(r => r.status === VenueEditRequestStatus.PENDING);\n  const expiredRequests = editRequests.filter(r => r.status === VenueEditRequestStatus.EXPIRED);\n  \n  const handleApprove = async (requestId: string, approveAll = false) => {\n    setLoading(true);\n    try {\n      const request = editRequests.find(r => r.id === requestId);\n      if (!request) return;\n      \n      if (approveAll) {\n        await onApprove(requestId, request.proposedChanges);\n      } else {\n        // TODO: Implement individual change approval\n        await onApprove(requestId, request.proposedChanges);\n      }\n      setSelectedRequest(null);\n    } catch (error) {\n      console.error('Failed to approve edit request:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleReject = async (requestId: string) => {\n    if (!rejectionReason.trim()) {\n      alert('Please provide a reason for rejection');\n      return;\n    }\n    \n    setLoading(true);\n    try {\n      await onReject(requestId, rejectionReason.trim());\n      setSelectedRequest(null);\n      setRejectionReason('');\n    } catch (error) {\n      console.error('Failed to reject edit request:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleTransferOwnership = async () => {\n    if (!transferToUserId.trim()) {\n      alert('Please provide the user ID to transfer ownership to');\n      return;\n    }\n    \n    setLoading(true);\n    try {\n      await onTransferOwnership(venue.id, transferToUserId.trim());\n      setShowTransferDialog(false);\n      setTransferToUserId('');\n    } catch (error) {\n      console.error('Failed to transfer ownership:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const formatChangeDescription = (changes: Record<string, any>): string => {\n    const descriptions: string[] = [];\n    \n    Object.entries(changes).forEach(([key, value]) => {\n      switch (key) {\n        case 'ageRestriction':\n          descriptions.push(`Age restriction: ${value}`);\n          break;\n        case 'minorStartTime':\n        case 'minorEndTime':\n          descriptions.push(`Minor hours: ${key.includes('Start') ? 'start' : 'end'} time to ${value}`);\n          break;\n        case 'ages18To20StartTime':\n        case 'ages18To20EndTime':\n          descriptions.push(`18-20 hours: ${key.includes('Start') ? 'start' : 'end'} time to ${value}`);\n          break;\n        case 'useVenueAgeForAllTables':\n          descriptions.push(`Table age management: ${value ? 'venue-wide' : 'manual'}`);\n          break;\n        default:\n          descriptions.push(`${key}: ${value}`);\n      }\n    });\n    \n    return descriptions.join(', ');\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h3 className=\"text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2\">\n            <Building className=\"h-6 w-6\" />\n            Venue Ownership & Edit Requests\n          </h3>\n          <p className=\"text-gray-600 dark:text-gray-400 mt-1\">\n            Manage venue ownership and approve edit requests from other tournament directors\n          </p>\n        </div>\n        \n        {isOwner && canManage && (\n          <button\n            onClick={() => setShowTransferDialog(true)}\n            className=\"bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2\"\n          >\n            <UserCheck className=\"h-4 w-4\" />\n            Transfer Ownership\n          </button>\n        )}\n      </div>\n\n      {/* Current Owner */}\n      <div className=\"bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4\">\n        <div className=\"flex items-center gap-2 mb-2\">\n          <User className=\"h-5 w-5 text-green-600 dark:text-green-400\" />\n          <span className=\"font-semibold text-green-900 dark:text-green-100\">Current Owner</span>\n        </div>\n        {venue.owner ? (\n          <div className=\"text-green-800 dark:text-green-200\">\n            {venue.owner.firstName} {venue.owner.lastName} ({venue.owner.email})\n            {isOwner && <span className=\"ml-2 text-sm font-medium\">(You)</span>}\n          </div>\n        ) : (\n          <div className=\"text-green-800 dark:text-green-200\">No owner assigned</div>\n        )}\n      </div>\n\n      {/* Pending Edit Requests */}\n      {pendingRequests.length > 0 && (\n        <div className=\"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg\">\n          <div className=\"px-6 py-4 border-b border-gray-200 dark:border-gray-700\">\n            <h4 className=\"text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2\">\n              <Clock className=\"h-5 w-5 text-yellow-600\" />\n              Pending Edit Requests ({pendingRequests.length})\n            </h4>\n          </div>\n          \n          <div className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n            {pendingRequests.map((request) => {\n              const timeLeft = Math.max(0, request.expiresAt.getTime() - Date.now());\n              const hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));\n              \n              return (\n                <div key={request.id} className=\"p-6\">\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-3 mb-2\">\n                        <Edit3 className=\"h-5 w-5 text-blue-600 dark:text-blue-400\" />\n                        <span className=\"font-semibold text-gray-900 dark:text-white\">\n                          {request.requester.firstName} {request.requester.lastName}\n                        </span>\n                        <span className=\"text-sm text-gray-500 dark:text-gray-400\">•</span>\n                        <span className=\"text-sm text-gray-500 dark:text-gray-400\">\n                          {request.requester.email}\n                        </span>\n                      </div>\n                      \n                      <div className=\"text-sm text-gray-600 dark:text-gray-300 mb-2\">\n                        <strong>Proposed Changes:</strong> {formatChangeDescription(request.proposedChanges)}\n                      </div>\n                      \n                      <div className=\"text-xs text-gray-500 dark:text-gray-400 mb-3\">\n                        Submitted: {request.createdAt.toLocaleString()}\n                        <span className=\"ml-3\">\n                          Expires in: {hoursLeft > 0 ? `${hoursLeft} hours` : 'Less than 1 hour'}\n                        </span>\n                      </div>\n                      \n                      {hoursLeft < 6 && (\n                        <div className=\"text-xs text-yellow-600 dark:text-yellow-400 mb-3\">\n                          ⚠️ This request will expire soon\n                        </div>\n                      )}\n                    </div>\n                    \n                    {isOwner && (\n                      <div className=\"flex gap-2 ml-4\">\n                        <button\n                          onClick={() => handleApprove(request.id, true)}\n                          disabled={loading}\n                          className=\"px-3 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-sm disabled:opacity-50 flex items-center gap-1\"\n                        >\n                          <Check className=\"h-3 w-3\" />\n                          Approve All\n                        </button>\n                        <button\n                          onClick={() => setSelectedRequest(request)}\n                          disabled={loading}\n                          className=\"px-3 py-1 bg-gray-600 hover:bg-gray-700 text-white rounded text-sm\"\n                        >\n                          Review\n                        </button>\n                        <button\n                          onClick={() => {\n                            setSelectedRequest(request);\n                            setRejectionReason('');\n                          }}\n                          disabled={loading}\n                          className=\"px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm disabled:opacity-50 flex items-center gap-1\"\n                        >\n                          <X className=\"h-3 w-3\" />\n                          Reject\n                        </button>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n      )}\n\n      {/* Expired Requests Notice */}\n      {expiredRequests.length > 0 && !isOwner && (\n        <div className=\"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4\">\n          <div className=\"flex items-center gap-2 text-red-800 dark:text-red-200\">\n            <AlertCircle className=\"h-5 w-5\" />\n            <div>\n              <div className=\"font-semibold\">Expired Edit Requests</div>\n              <div className=\"text-sm mt-1\">\n                {expiredRequests.length} edit request(s) have expired without review. \n                After 3 expired requests, you can request to take ownership of this venue.\n              </div>\n              {expiredRequests.length >= 3 && (\n                <button \n                  className=\"mt-2 text-sm underline\"\n                  onClick={() => setShowTransferDialog(true)}\n                >\n                  Request Venue Ownership\n                </button>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* No Requests */}\n      {pendingRequests.length === 0 && (\n        <div className=\"text-center py-6 text-gray-500 dark:text-gray-400\">\n          No pending edit requests for this venue.\n        </div>\n      )}\n\n      {/* Edit Request Detail Modal */}\n      {selectedRequest && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\">\n          <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-lg w-full\">\n            <div className=\"p-6\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">Review Edit Request</h3>\n                <button\n                  onClick={() => setSelectedRequest(null)}\n                  className=\"text-gray-400 hover:text-gray-600\"\n                >\n                  <X className=\"h-6 w-6\" />\n                </button>\n              </div>\n              \n              <div className=\"space-y-4\">\n                <div>\n                  <div className=\"font-medium text-gray-900 dark:text-white mb-1\">Requested by:</div>\n                  <div className=\"text-gray-600 dark:text-gray-300\">\n                    {selectedRequest.requester.firstName} {selectedRequest.requester.lastName}\n                  </div>\n                </div>\n                \n                <div>\n                  <div className=\"font-medium text-gray-900 dark:text-white mb-2\">Proposed Changes:</div>\n                  <div className=\"space-y-2\">\n                    {Object.entries(selectedRequest.proposedChanges).map(([key, value]) => (\n                      <div key={key} className=\"flex justify-between text-sm\">\n                        <span className=\"text-gray-600 dark:text-gray-400\">{key}:</span>\n                        <span className=\"text-gray-900 dark:text-white font-mono\">{String(value)}</span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n                \n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                    Rejection Reason (if rejecting)\n                  </label>\n                  <textarea\n                    value={rejectionReason}\n                    onChange={(e) => setRejectionReason(e.target.value)}\n                    className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\n                    rows={3}\n                    placeholder=\"Optional reason for rejection...\"\n                  />\n                </div>\n              </div>\n              \n              <div className=\"flex gap-3 mt-6\">\n                <button\n                  onClick={() => handleApprove(selectedRequest.id, true)}\n                  disabled={loading}\n                  className=\"flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg disabled:opacity-50\"\n                >\n                  Approve All\n                </button>\n                <button\n                  onClick={() => handleReject(selectedRequest.id)}\n                  disabled={loading || !rejectionReason.trim()}\n                  className=\"flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg disabled:opacity-50\"\n                >\n                  Reject\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Transfer Ownership Dialog */}\n      {showTransferDialog && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50\">\n          <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full\">\n            <div className=\"p-6\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white\">Transfer Ownership</h3>\n                <button\n                  onClick={() => setShowTransferDialog(false)}\n                  className=\"text-gray-400 hover:text-gray-600\"\n                >\n                  <X className=\"h-6 w-6\" />\n                </button>\n              </div>\n              \n              <div className=\"space-y-4\">\n                <div className=\"text-sm text-gray-600 dark:text-gray-300\">\n                  Transfer ownership of this venue to another tournament director. The new owner will be able to approve edit requests and manage the venue.\n                </div>\n                \n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                    New Owner User ID\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={transferToUserId}\n                    onChange={(e) => setTransferToUserId(e.target.value)}\n                    className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\n                    placeholder=\"Enter user ID...\"\n                  />\n                </div>\n              </div>\n              \n              <div className=\"flex gap-3 mt-6\">\n                <button\n                  onClick={() => setShowTransferDialog(false)}\n                  disabled={loading}\n                  className=\"flex-1 px-4 py-2 border border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-50 disabled:opacity-50\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={handleTransferOwnership}\n                  disabled={loading || !transferToUserId.trim()}\n                  className=\"flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg disabled:opacity-50\"\n                >\n                  {loading ? 'Transferring...' : 'Transfer'}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}"